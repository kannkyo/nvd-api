"""
    NVD API 2.0 Python API

    No description provided (generated by Openapi Generator https://github.com/openapitools/openapi-generator)  # noqa: E501

    The version of the OpenAPI document: 0.1.0
    Contact: 15080890+kannkyo@users.noreply.github.com
    Generated by: https://openapi-generator.tech
"""


import os
import unittest
from pprint import pprint

from nvd_api.client import EVENT_NAME, NvdApiClient
from nvd_api.low_api.exceptions import ApiValueError, NotFoundException


class TestGetCveHistory(unittest.TestCase):
    def setUp(self):
        api_key = os.getenv('NVD_API_KEY')
        if api_key:
            self.client = NvdApiClient(wait_time=1 * 1000, api_key=api_key)  # noqa: E501
        else:
            self.client = NvdApiClient(wait_time=10 * 1000)  # noqa: E501

    def tearDown(self):
        pass

    def test_get_by_change_date(self):
        response = self.client.get_cve_history(
            change_start_date="2021-08-04T00:00:00.000",
            change_end_date="2021-10-23T00:00:00.000",
            event_name=EVENT_NAME.CVE_REJECTED,
            results_per_page=1,
            start_index=1
        )
        pprint(response)
        assert (len(response.cve_changes) > 0)

    def test_get_by_cve(self):
        response = self.client.get_cve_history(
            cve_id="CVE-2019-1010218",
            results_per_page=1,
            start_index=1
        )
        pprint(response)
        assert (len(response.cve_changes) > 0)

    def test_use_change_start_date_without_change_end_date(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                change_start_date="2021-08-04T00:00:00.000",
                event_name=EVENT_NAME.CVE_REJECTED,
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_use_change_end_date_without_change_start_date(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                change_end_date="2021-10-23T00:00:00.000",
                event_name=EVENT_NAME.CVE_REJECTED,
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_invalid_change_start_date(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                change_start_date="invalid datetime",
                change_end_date="2021-10-23T00:00:00.000",
                event_name=EVENT_NAME.CVE_REJECTED,
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_invalid_change_end_date(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                change_start_date="2021-08-04T00:00:00.000",
                change_end_date="invalid datetime",
                event_name=EVENT_NAME.CVE_REJECTED,
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_invalid_change_date_range(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                change_start_date="2018-12-01T00:00:00.000",
                change_end_date="2019-04-01T00:00:00.000",  # 121 days
                event_name=EVENT_NAME.CVE_REJECTED,
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_invalid_cve_id(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                cve_id="INVALID-2019-1010218",
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_invalid_event_name(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                change_start_date="2021-08-04T00:00:00.000",
                change_end_date="2021-10-23T00:00:00.000",
                event_name="INVALID",
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_invalid_results_per_page(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                cve_id="CVE-2019-1010218",
                results_per_page=5001,
                start_index=1
            )
            pprint(response)

        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                cve_id="CVE-2019-1010218",
                results_per_page=-1,
                start_index=1
            )
            pprint(response)

    def test_invalid_start_index(self):
        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                cve_id="CVE-2019-1010218",
                results_per_page=1,
                start_index=-1
            )
            pprint(response)

    def test_invalid_api_key(self):
        with self.assertRaises(NotFoundException):
            client = NvdApiClient(wait_time=15 * 1000, api_key='invalid key')
            response = client.get_cve_history(
                cve_id="CVE-2019-1010218",
                results_per_page=1,
                start_index=1
            )
            pprint(response)

    def test_max_page_limit(self):
        max_limit = NvdApiClient.MAX_PAGE_LIMIT_CVE_HISTORY_API
        response = self.client.get_cve_history(results_per_page=max_limit)
        assert (len(response.cve_changes) > 0)

        with self.assertRaises(ApiValueError):
            response = self.client.get_cve_history(
                results_per_page=max_limit + 1)


if __name__ == '__main__':
    unittest.main()
